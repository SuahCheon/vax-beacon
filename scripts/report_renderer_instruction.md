# Implement Report Renderer for Vax-Beacon v4

## Overview

Add a code-only report renderer that converts pipeline JSON output into a readable Markdown report for epidemiological officers. No LLM needed — Stage 6 summary is reused. Optionally generates Word (.docx) with `--docx` flag.

## Architecture

```
Pipeline result (dict) → report_renderer.py → reports/VAERS_{id}_v4.md
                                            → reports/VAERS_{id}_v4.docx (if --docx)
```

The renderer is NOT a pipeline stage. It's a post-processing step that runs after save_results().

## Step 1: Create `report_renderer.py` (root level)

Pure Python, no LLM calls. Reads the pipeline result dict and generates Markdown.

### Input
Single case result dict (same structure as what's saved in results/*.json).

### Output Template (Markdown)

```markdown
# Vax-Beacon v4.3 — AEFI Causality Assessment Report

**VAERS ID:** {vaers_id} | **Generated:** {timestamp} | **Processing:** {total_time}s

---

## Patient Profile

| Field | Value |
|-------|-------|
| Age / Sex | {age} {sex} |
| State | {state} |
| Vaccine | {vaccine_name}, Dose #{dose}, {vax_date} |
| Onset | {onset_date} ({days_to_onset} days post-vaccination) |
| Symptoms | {symptoms} |
| Medical History | {history} |
| Outcome | {outcome} |
| Data Quality | Richness {richness}/10 |

## Diagnostic Validation (Brighton)

**Brighton Level: {level}** — {justification}

| Criterion | Result |
|-----------|--------|
| Histopathology | {✓/✗} |
| Cardiac MRI | {✓/✗} |
| Troponin elevated | {✓/✗} |
| ECG abnormal | {✓/✗} |
| Echo abnormal | {✓/✗} |
| Compatible symptoms | {✓/✗} |
| Inflammatory markers | {✓/✗} |

{IF early_exit: show "⚠️ EARLY EXIT — Insufficient diagnostic evidence" and skip to Stage 6}

## Differential Diagnosis (WHO Step 1)

### Clinical Observations
{stage3a observations summary}

### DDx Candidates
| Etiology | NCI Score | Key Markers | Status |
|----------|-----------|-------------|--------|
{for each etiology with NCI > 0}

**WHO Step 1 Conclusion:** {who_step1_conclusion}
**Dominant Alternative:** {dominant_alternative}

### Plausibility Highlights
{stage3c key decisions — especially rejected markers with rationale}

## Temporal Assessment (WHO Step 2)

| Parameter | Value |
|-----------|-------|
| Known AE | {known_ae_status} |
| Days to onset | {days} |
| Temporal zone | {zone} |
| WHO Step 2 Met | {yes/no} |

## WHO Causality Classification

### **{who_category}** — {who_category_label}
**Confidence:** {confidence}
**Classification Source:** {deterministic/llm}

**Decision Chain:**
{Q1 → Q2 → ... formatted as decision trace}

**Reasoning:**
{stage5 reasoning text}

## Investigation Guidance

**Overall Risk Signal:** {risk_signal}

| Priority | Gap | Action | Classification Impact |
|----------|-----|--------|----------------------|
{stage6 investigative_gaps rows}

### Quality Assessment
| Flag | Value |
|------|-------|
| Data completeness | {value} |
| Diagnostic certainty | {value} |
| Temporal clarity | {value} |

## Officer Summary

> {stage6 officer_summary text — blockquote for emphasis}

---
*Report generated by Vax-Beacon v4.3 | {timestamp}*
```

### Early Exit Template

For Brighton L4 cases, use a shorter template:
- Patient Profile (same)
- Brighton Validation (same, with EARLY EXIT banner)
- Skip DDx / Temporal / Classification sections
- Show Stage 6 Early Exit guidance:
  - Diagnostic deficiencies table
  - Fastest path to classification
  - Alternative diagnoses noted
  - Officer Summary

### Implementation Notes

```python
"""
Vax-Beacon v4 | Report Renderer (Code Only)
=============================================
Converts pipeline result dict → Markdown report.
No LLM calls. Reuses Stage 6 officer summary.
Optional .docx conversion with python-docx.
"""

import os
from datetime import datetime

REPORTS_PATH = "reports"


def render_report(result: dict, output_dir: str = REPORTS_PATH) -> str:
    """
    Render a single case result to Markdown.
    Returns the filepath of the generated report.
    """
    os.makedirs(output_dir, exist_ok=True)
    vaers_id = result["vaers_id"]
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
    
    if result.get("early_exit"):
        md = _render_early_exit(result, timestamp)
    else:
        md = _render_full(result, timestamp)
    
    filename = f"VAERS_{vaers_id}_v4.md"
    filepath = os.path.join(output_dir, filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(md)
    
    return filepath


def render_docx(md_path: str) -> str | None:
    """
    Convert Markdown report to Word document.
    Returns filepath or None if python-docx not available.
    """
    try:
        from docx import Document as DocxDocument
        from docx.shared import Inches, Pt
    except ImportError:
        print("  [Report] python-docx not installed, skipping .docx generation")
        return None
    
    # Read markdown and convert to docx
    # ... implementation details ...
    docx_path = md_path.replace(".md", ".docx")
    return docx_path


def _render_full(result: dict, timestamp: str) -> str:
    """Render full pipeline report (Brighton L1-L3)."""
    # Extract data from each stage
    s1 = result["stages"].get("stage1_icsr", {})
    s2 = result["stages"].get("stage2_brighton", {})
    s3 = result["stages"].get("stage3_ddx", {})
    s4 = result["stages"].get("stage4_temporal", {})
    s5 = result["stages"].get("stage5_causality", {})
    s6 = result["stages"].get("stage6_guidance", {})
    
    lines = []
    lines.append(_header(result, timestamp))
    lines.append(_patient_profile(s1))
    lines.append(_brighton(s2))
    lines.append(_ddx(s3))
    lines.append(_temporal(s4))
    lines.append(_classification(s5))
    lines.append(_guidance(s6))
    lines.append(_footer(timestamp))
    
    return "\n".join(lines)


def _render_early_exit(result: dict, timestamp: str) -> str:
    """Render early exit report (Brighton L4)."""
    s1 = result["stages"].get("stage1_icsr", {})
    s2 = result["stages"].get("stage2_brighton", {})
    s6 = result["stages"].get("stage6_guidance", {})
    
    lines = []
    lines.append(_header(result, timestamp))
    lines.append(_patient_profile(s1))
    lines.append(_brighton(s2, early_exit=True))
    lines.append(_early_exit_guidance(s6))
    lines.append(_footer(timestamp))
    
    return "\n".join(lines)


# Helper functions: _header, _patient_profile, _brighton, _ddx, 
# _temporal, _classification, _guidance, _early_exit_guidance, _footer
# Each returns a string of Markdown content.
```

Key implementation rules:
- Use `result["stages"]["stage6_guidance"]["officer_summary"]` directly for the summary
- Use `result["stages"]["stage5_causality"]["reasoning"]` for classification rationale  
- Handle missing keys gracefully with `.get()` defaults
- Use ✓/✗ for boolean Brighton criteria
- Format NCI scores to 2 decimal places
- All text in English

## Step 2: Integrate into `main.py`

### Add import
```python
from report_renderer import render_report, render_docx
```

### Add `--docx` argument
```python
parser.add_argument("--docx", action="store_true", help="Also generate Word report")
```

### Add report generation after save_results()

In the `main()` function, after `save_results(results, tag=tag)`:

```python
# Generate reports for single-case runs
if args.case and results:
    report_path = render_report(results[0])
    print(f"Report: {report_path}")
    if args.docx:
        docx_path = render_docx(report_path)
        if docx_path:
            print(f"Word report: {docx_path}")
```

Only auto-generate for `--case` runs (not batch runs). For batch, reports can be generated separately if needed.

## Step 3: Test

```bash
# Full pipeline case
python main.py --case 1347846
# Should print: Report: reports/VAERS_1347846_v4.md

# Early exit case  
python main.py --case 1313197
# Should print: Report: reports/VAERS_1313197_v4.md

# With Word output
python main.py --case 1347846 --docx
# Should print both .md and .docx paths
```

Verify:
1. `reports/VAERS_1347846_v4.md` exists and is readable
2. `reports/VAERS_1313197_v4.md` has Early Exit template
3. Both reports contain Officer Summary from Stage 6
4. No LLM calls in report_renderer.py

## Step 4: Git commit

```bash
git add report_renderer.py main.py reports/
git commit -m "feat: add report renderer (code template, no LLM) with optional docx"
```

## Important

- Do NOT add python-docx to requirements.txt — it's optional
- The .docx conversion can be basic (paragraphs + tables). No need for fancy formatting.
- If python-docx is not installed, gracefully skip with a message
- Reports folder should be in .gitignore (generated output)
